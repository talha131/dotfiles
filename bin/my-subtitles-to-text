#!/usr/bin/env python3
"""
Convert VTT and SRT subtitle files to plain text.

Strips timestamps, cue numbers, and metadata.

Usage:
    my-subtitles-to-text file.srt              # creates file.txt
    my-subtitles-to-text file.srt -o out.txt   # creates out.txt
"""

from __future__ import annotations

import argparse
import re
import sys
from pathlib import Path

# VTT: 00:00:00.000 --> 00:00:00.000
# SRT: 00:00:00,000 --> 00:00:00,000
TIMESTAMP_RE = re.compile(r"\d{2}:\d{2}:\d{2}[.,]\d{3}\s*-->")
TAG_RE = re.compile(r"<[^>]+>")


def subtitle_to_text(path: Path) -> str:
    """Extract plain text from a VTT or SRT file."""
    lines: list[str] = []
    for raw_line in path.read_text(encoding="utf-8").splitlines():
        line = raw_line.strip()
        if not line:
            continue
        # Skip VTT headers
        if line.startswith(("WEBVTT", "Kind:", "Language:", "NOTE")):
            continue
        # Skip timestamp lines
        if TIMESTAMP_RE.search(line):
            continue
        # Skip cue numbers (standalone digits)
        if line.isdigit():
            continue
        # Remove HTML-like tags (e.g., <c>, </c>, <b>)
        cleaned = TAG_RE.sub("", line).strip()
        if cleaned:
            lines.append(cleaned)
    return "\n".join(lines)


def main() -> int:
    parser = argparse.ArgumentParser(
        description="Convert a VTT/SRT subtitle file to plain text.",
    )
    parser.add_argument(
        "file",
        type=Path,
        help="Subtitle file (.vtt or .srt).",
    )
    parser.add_argument(
        "-o", "--output",
        type=Path,
        help="Output directory (default: same directory as input file).",
    )

    args = parser.parse_args()
    input_path = args.file.resolve()

    if not input_path.is_file():
        print(f"Error: File not found: {input_path}", file=sys.stderr)
        return 1

    if input_path.suffix.lower() not in (".vtt", ".srt"):
        print(f"Error: Not a subtitle file (.vtt/.srt): {input_path}", file=sys.stderr)
        return 1

    if args.output:
        output_dir = args.output.resolve()
        output_dir.mkdir(parents=True, exist_ok=True)
        output_path = output_dir / input_path.with_suffix(".txt").name
    else:
        output_path = input_path.with_suffix(".txt")

    if output_path.exists():
        print(f"Error: Output file already exists: {output_path.name}", file=sys.stderr)
        return 1

    text = subtitle_to_text(input_path)
    if not text:
        print(f"Warning: No text extracted from {input_path.name}", file=sys.stderr)
        return 0

    output_path.write_text(text + "\n", encoding="utf-8")
    print(f"âœ“ Saved: {output_path.name}", file=sys.stderr)
    return 0


if __name__ == "__main__":
    sys.exit(main())
