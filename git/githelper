#!/bin/bash 


HASH="%C(bold yellow)%h%Creset"
AUTHOR_DATE="%Cgreen%ad%Creset" # format respects --date= option
AUTHOR="%Cblue%aN%Creset"
REFS="%C(bold red)%d%Creset"
SUBJECT="%s"

FORMAT="$HASH}$AUTHOR_DATE}$AUTHOR}$REFS $SUBJECT"

ANSI_MAGENTA='\033[35m'
ANSI_RESET='\033[0m'
YELLOW='\033[1;33m'
BOLD=$(tput bold)
NORMAL=$(tput sgr0)

function merge_conflicts_possible() {
    if [ "$1" == 'upstream' -o "$1" == 'origin' ];
    then
        echo "${YELLOW}${BOLD}Fetching $1${NORMAL}"
        git fetch $1
        fetch_head="$1/master"
    else
        fetch_head="$1"
    fi

    printf "${YELLOW}${BOLD}Checking merge conflicts between "
    printf "${ANSI_MAGENTA}$fetch_head${ANSI_RESET} "
    printf "${YELLOW}${BOLD}and "
    printf "${ANSI_MAGENTA}$(git branch-name)${ANSI_RESET}${NORMAL}\n"

    merge_base=$(git merge-base "$fetch_head" "$(git branch-name)")

    git merge-tree $merge_base "fetch_head" "$(git branch-name)" | grep -A3 "changed in both"
}

function merge_remote() {
    echo "${YELLOW}${BOLD}Fetching $1${NORMAL}"
    git fetch "$1"
    if (("$(git branch-name)" == 'master'));
    then
        echo "${YELLOW}${BOLD}Doing fast forward merge${NORMAL}"
        git merge --ff $1/master
        echo "${YELLOW}${BOLD}Pushing to origin${NORMAL}"
        git push
    else 
        echo "${YELLOW}${BOLD}Doing non fast forward merge${NORMAL}"
        git merge --no-ff $1/master
    fi
}

function pretty_git_log_subject_body {

     git log --date=short --pretty="format:${FORMAT}%n%b" $* |
        sed -Ee "s/}/  /g" |
        # Color merge commits specially
        sed -Ee "s/(Merge .*$)/$(printf $ANSI_MAGENTA)\1$(printf $ANSI_RESET)/" |
        # Page only if needed
        less -FXRS
}

function pretty_git_log_graph {

     git log --date=short --pretty="format:${FORMAT}" --graph --topo-order $* |
        sed -Ee "s/}/  /g" |
        # Color merge commits specially
        sed -Ee "s/(Merge .*$)/$(printf $ANSI_MAGENTA)\1$(printf $ANSI_RESET)/" |
        # Page only if needed
        less -FXRS
}

function pretty_git_log_subject {

     git log --date=short --pretty="format:${FORMAT}%n" $* |
        # Line columns up based on } delimiter
        column -s '}' -t 2> /dev/null |
        # Color merge commits specially
        sed -Ee "s/(Merge .*$)/$(printf $ANSI_MAGENTA)\1$(printf $ANSI_RESET)/" |
        # Page only if needed
        less -FXRS
}

function pretty_git_log_stats {

     git log --date=short --pretty="format:${FORMAT}" --stat $* |
        sed 's/}/ /g' |
        # indent stats by a tab for readability
        sed 's/^ /	/g' |
        sed -Ee "s/(Merge .*$)/$(printf $ANSI_MAGENTA)\1$(printf $ANSI_RESET)/" |
        less -FXRS
}
